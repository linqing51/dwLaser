C51 COMPILER V9.57.0.0   PIDFUZZY                                                          05/07/2018 22:16:18 PAGE 1   


C51 COMPILER V9.57.0.0, COMPILATION OF MODULE PIDFUZZY
OBJECT MODULE PLACED IN .\Objects\pidFuzzy.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Source\MainApp\pidFuzzy.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\Source
                    -\Lib;.\Source\Driver;.\Source\Modbus;.\Source\MainApp) DEBUG OBJECTEXTEND PRINT(.\Listings\pidFuzzy.lst) OBJECT(.\Object
                    -s\pidFuzzy.obj)

line level    source

   1          #include "pidFuzzy.h"
   2          /*****************************************************************************/
   3          //×¢1£º×ÔÊÊÓ¦Ä£ºýpid×îÖØÒªµÄ¾ÍÊÇÂÛÓòµÄÑ¡Ôñ£¬ÒªºÍÄãÓ¦¸Ã¿ØÖÆµÄ¶ÔÏóÏàÇÐºÏ
   4          //×¢2£ºÒÔÏÂ¸÷·§Öµ¡¢ÏÞ·ùÖµ¡¢Êä³öÖµ¾ùÐèÒª¸ù¾Ý¾ßÌåµÄÊ¹ÓÃÇé¿ö½øÐÐ¸ü¸Ä
   5          //×¢3£ºÒòÎªÎÒµÄ¿ØÖÆ¶ÔÏó¹ßÐÔ±È½Ï´ó£¬ËùÒÔÒÔÏÂ¸÷²¿·ÖÈ¡Öµ½ÏÐ¡
   6          //ÂÛÓòe:[-5,5]  ec:[-0.5,0.5]
   7          
   8          //Îó²îµÄ·§Öµ£¬Ð¡ÓÚÕâ¸öÊýÖµµÄÊ±ºò£¬²»×öPIDµ÷Õû£¬±ÜÃâÎó²î½ÏÐ¡Ê±Æµ·±µ÷½ÚÒýÆðÕðµ´
   9          /*****************************************************************************/
  10          
  11          #define NB 0
  12          #define NM 1
  13          #define NS 2
  14          #define ZO 3
  15          #define PS 4
  16          #define PM 5
  17          #define PB 6
  18          
  19          int kp[7][7]={  {PB,PB,PM,PM,PS,ZO,ZO},
  20                                          {PB,PB,PM,PS,PS,ZO,ZO},
  21                                          {PM,PM,PM,PS,ZO,NS,NS},
  22                                          {PM,PM,PS,ZO,NS,NM,NM},
  23                                          {PS,PS,ZO,NS,NS,NM,NM},
  24                                          {PS,ZO,NS,NM,NM,NM,NB},
  25                                          {ZO,ZO,NM,NM,NM,NB,NB}    };
  26          
  27          int kd[7][7]={  {PS,NS,NB,NB,NB,NM,PS},
  28                                          {PS,NS,NB,NM,NM,NS,ZO},
  29                                          {ZO,NS,NM,NM,NS,NS,ZO},
  30                                          {ZO,NS,NS,NS,NS,NS,ZO},
  31                                          {ZO,ZO,ZO,ZO,ZO,ZO,ZO},
  32                                          {PB,NS,PS,PS,PS,PS,PB},
  33                                          {PB,PM,PM,PM,PS,PS,PB}    };
  34          
  35          int ki[7][7]={  {NB,NB,NM,NM,NS,ZO,ZO},
  36                                          {NB,NB,NM,NS,NS,ZO,ZO},
  37                                          {NB,NM,NS,NS,ZO,PS,PS},
  38                                          {NM,NM,NS,ZO,PS,PM,PM},
  39                                          {NM,NS,ZO,PS,PS,PM,PB},
  40                                          {ZO,ZO,PS,PS,PM,PB,PB},
  41                                          {ZO,ZO,PS,PM,PM,PB,PB}    };
  42          
  43          /**************ÇóÁ¥Êô¶È£¨Èý½ÇÐÎ£©***************/
  44          fp32_t FTri(fp32_t x,fp32_t a,fp32_t b,fp32_t c)//FuzzyTriangle
  45          {
  46   1              if(x<=a)
  47   1                      return 0;
  48   1              else if((a<x)&&(x<=b))
  49   1                      return (x-a)/(b-a);
  50   1              else if((b<x)&&(x<=c))
  51   1                      return (c-x)/(c-b);
  52   1              else if(x>c)
  53   1                      return 0;
C51 COMPILER V9.57.0.0   PIDFUZZY                                                          05/07/2018 22:16:18 PAGE 2   

  54   1              else
  55   1                      return 0;
  56   1      }
  57          /*****************ÇóÁ¥Êô¶È£¨ÌÝÐÎ×ó£©*******************/
  58          fp32_t FTraL(fp32_t x,fp32_t a,fp32_t b)//FuzzyTrapezoidLeft
  59          {
  60   1              if(x<=a)  
  61   1                      return 1;
  62   1              else if((a<x)&&(x<=b))
  63   1                      return (b-x)/(b-a);
  64   1              else if(x>b)
  65   1                      return 0;
  66   1              else
  67   1                      return 0;
  68   1      }
  69          /*****************ÇóÁ¥Êô¶È£¨ÌÝÐÎÓÒ£©*******************/
  70          fp32_t FTraR(fp32_t x,fp32_t a,fp32_t b)//FuzzyTrapezoidRight
  71          {
  72   1              if(x<=a)
  73   1                      return 0;
  74   1              if((a<x)&&(x<b))
  75   1                      return (x-a)/(b-a);
  76   1              if(x>=b)
  77   1                      return 1;
  78   1              else
  79   1                      return 1;
  80   1      }
  81          /****************Èý½ÇÐÎ·´Ä£ºý»¯´¦Àí**********************/
  82          fp32_t uFTri(fp32_t x,fp32_t a,fp32_t b,fp32_t c)
  83          { 
  84   1              fp32_t y,z;
  85   1              z=(b-a)*x+a;
  86   1              y=c-(c-b)*x;
  87   1              return (y+z)/2;
  88   1      }
  89          /*******************ÌÝÐÎ£¨×ó£©·´Ä£ºý»¯***********************/
  90          fp32_t uFTraL(fp32_t x,fp32_t a,fp32_t b)
  91          {
  92   1              return b-(b-a)*x;
  93   1      }
  94          /*******************ÌÝÐÎ£¨ÓÒ£©·´Ä£ºý»¯***********************/
  95          fp32_t uFTraR(fp32_t x,fp32_t a,fp32_t b)
  96          {
  97   1              return (b-a)*x +a;
  98   1      }
  99          /**************************Çó½»¼¯****************************/
 100          fp32_t fand(fp32_t a,fp32_t b)
 101          {
 102   1              return (a<b)?a:b;
 103   1      }
 104          /**************************Çó²¢¼¯****************************/
 105          fp32_t forr(fp32_t a,fp32_t b)
 106          {
 107   1              return (a<b)?b:a;
 108   1      }
 109          fp32_t ec;
 110           
 111          int16_t pidFuzzyRealize(pidFuzzy_t *structpid,uint16_t s,uint16_t in)
 112          {//PID¼ÆËã²¿·Ö
 113   1              fp32_t pwm_var;//pwmµ÷ÕûÁ¿
 114   1              fp32_t iError;//µ±Ç°Îó²î
 115   1              fp32_t set, input;
C51 COMPILER V9.57.0.0   PIDFUZZY                                                          05/07/2018 22:16:18 PAGE 3   

 116   1              
 117   1              //¼ÆËãÁ¥Êô¶È±í
 118   1              fp32_t es[7], ecs[7],e;
 119   1              fp32_t form[7][7];
 120   1              int i=0,j=0;
 121   1              int MaxX=0, MaxY=0;
 122   1              
 123   1              //¼ÇÂ¼Á¥Êô¶È×î´óÏî¼°ÏàÓ¦ÍÆÀí±íµÄp¡¢i¡¢dÖµ
 124   1              fp32_t lsd;
 125   1              int temp_p, temp_d, temp_i;
 126   1              fp32_t detkp, detkd, detki;//ÍÆÀíºóµÄ½á¹û
 127   1              
 128   1              //ÊäÈë¸ñÊ½µÄ×ª»¯¼°Æ«²î¼ÆËã
 129   1              set=(fp32_t)s/100.0;
 130   1              input=(fp32_t)in/100.0;
 131   1              iError = set - input; // Æ«²î
 132   1              
 133   1              e = iError;
 134   1              ec = iError - structpid->LastError;
 135   1              
 136   1              //µ±ÎÂ¶È²îµÄ¾ø¶ÔÖµÐ¡ÓÚEmaxÊ±£¬¶ÔpidµÄ²ÎÊý½øÐÐµ÷Õû
 137   1              if(fabs(iError)<=CONFIG_PID_FUZZY_EMAX)
 138   1              {
 139   2                      //¼ÆËãiErrorÔÚesÓëecsÖÐ¸÷ÏîµÄÁ¥Êô¶È
 140   2                      es[NB]=FTraL(e*5,-3,-1);  //e 
 141   2                      es[NM]=FTri(e*5,-3,-2,0);
 142   2                      es[NS]=FTri(e*5,-3,-1,1);
 143   2                      es[ZO]=FTri(e*5,-2,0,2);
 144   2                      es[PS]=FTri(e*5,-1,1,3);
 145   2                      es[PM]=FTri(e*5,0,2,3);
 146   2                      es[PB]=FTraR(e*5,1,3);
 147   2      
 148   2                      ecs[NB]=FTraL(ec*30,-3,-1);//ec
 149   2                      ecs[NM]=FTri(ec*30,-3,-2,0);
 150   2                      ecs[NS]=FTri(ec*30,-3,-1,1);
 151   2                      ecs[ZO]=FTri(ec*30,-2,0,2);
 152   2                      ecs[PS]=FTri(ec*30,-1,1,3);
 153   2                      ecs[PM]=FTri(ec*30,0,2,3);
 154   2                      ecs[PB]=FTraR(ec*30,1,3);
 155   2              
 156   2                      //¼ÆËãÁ¥Êô¶È±í£¬È·¶¨eºÍecÏà¹ØÁªºó±í¸ñ¸÷ÏîÁ¥Êô¶ÈµÄÖµ
 157   2                      for(i=0;i<7;i++)
 158   2                      {
 159   3                              for(j=0;j<7;j++)
 160   3                              {
 161   4                                      form[i][j]=fand(es[i],ecs[j]);
 162   4                              }
 163   3                      }
 164   2              
 165   2                      //È¡³ö¾ßÓÐ×î´óÁ¥Êô¶ÈµÄÄÇÒ»Ïî
 166   2                      for(i=0;i<7;i++)
 167   2                      {
 168   3                              for(j=0;j<7;j++)
 169   3                              {
 170   4                                      if(form[MaxX][MaxY]<form[i][j]) 
 171   4                                      {
 172   5                                              MaxX=i;
 173   5                                              MaxY=j;
 174   5                                      }
 175   4                              }
 176   3                      }
 177   2                      //½øÐÐÄ£ºýÍÆÀí£¬²¢È¥Ä£ºý
C51 COMPILER V9.57.0.0   PIDFUZZY                                                          05/07/2018 22:16:18 PAGE 4   

 178   2                      lsd=form[MaxX][MaxY];
 179   2                      temp_p=kp[MaxX][MaxY];
 180   2                      temp_d=kd[MaxX][MaxY];   
 181   2                      temp_i=ki[MaxX][MaxY];
 182   2              
 183   2                      if(temp_p==NB)
 184   2                              detkp=uFTraL(lsd,-0.3,-0.1);
 185   2                      else if(temp_p==NM)
 186   2                              detkp=uFTri(lsd,-0.3,-0.2,0);
 187   2                      else if(temp_p==NS)
 188   2                              detkp=uFTri(lsd,-0.3,-0.1,0.1);
 189   2                      else if(temp_p==ZO)
 190   2                              detkp=uFTri(lsd,-0.2,0,0.2);
 191   2                      else if(temp_p==PS)
 192   2                              detkp=uFTri(lsd,-0.1,0.1,0.3);
 193   2                      else if(temp_p==PM)
 194   2                              detkp=uFTri(lsd,0,0.2,0.3);
 195   2                      else if(temp_p==PB)
 196   2                              detkp=uFTraR(lsd,0.1,0.3);
 197   2      
 198   2                      if(temp_d==NB)
 199   2                              detkd=uFTraL(lsd,-3,-1);
 200   2                      else if(temp_d==NM)
 201   2                              detkd=uFTri(lsd,-3,-2,0);
 202   2                      else if(temp_d==NS)
 203   2                              detkd=uFTri(lsd,-3,1,1);
 204   2                      else if(temp_d==ZO)
 205   2                              detkd=uFTri(lsd,-2,0,2);
 206   2                      else if(temp_d==PS)
 207   2                              detkd=uFTri(lsd,-1,1,3);
 208   2                      else if(temp_d==PM)
 209   2                              detkd=uFTri(lsd,0,2,3);
 210   2                      else if(temp_d==PB)
 211   2                              detkd=uFTraR(lsd,1,3);
 212   2      
 213   2                      if(temp_i==NB)
 214   2                              detki=uFTraL(lsd,-0.06,-0.02);
 215   2                      else if(temp_i==NM)
 216   2                              detki=uFTri(lsd,-0.06,-0.04,0);
 217   2                      else if(temp_i==NS)
 218   2                              detki=uFTri(lsd,-0.06,-0.02,0.02);
 219   2                      else if(temp_i==ZO)
 220   2                              detki=uFTri(lsd,-0.04,0,0.04);
 221   2                      else if(temp_i==PS)
 222   2                              detki=uFTri(lsd,-0.02,0.02,0.06);
 223   2                      else if(temp_i==PM)
 224   2                              detki=uFTri(lsd,0,0.04,0.06);
 225   2                      else if (temp_i==PB)
 226   2                              detki=uFTraR(lsd,0.02,0.06);
 227   2      
 228   2                      //pidÈýÏîÏµÊýµÄÐÞ¸Ä
 229   2                      structpid->Kp+=detkp;
 230   2                      structpid->Ki+=detki;
 231   2                      //structpid->Kd+=detkd;
 232   2                      structpid->Kd=0;//È¡ÏûÎ¢·Ö×÷ÓÃ
 233   2                      
 234   2                      //¶ÔKp,Ki½øÐÐÏÞ·ù
 235   2                      if(structpid->Kp<0)
 236   2                      {
 237   3                              structpid->Kp=0;
 238   3                      }
 239   2                      if(structpid->Ki<0)
C51 COMPILER V9.57.0.0   PIDFUZZY                                                          05/07/2018 22:16:18 PAGE 5   

 240   2                      {
 241   3                              structpid->Ki=0;
 242   3                      }
 243   2                      
 244   2                      //¼ÆËãÐÂµÄK1,K2,K3
 245   2                      structpid->K1=structpid->Kp+structpid->Ki+structpid->Kd;
 246   2                      structpid->K2=-(structpid->Kp+2*structpid->Kd);
 247   2                      structpid->K3=structpid->Kd;
 248   2              }
 249   1              
 250   1              if(iError>CONFIG_PID_FUZZY_EMAX)
 251   1              {
 252   2                      structpid->pwm_out=7200;
 253   2                      pwm_var = 0;
 254   2                      structpid->flag=1;//Éè¶¨±êÖ¾Î»£¬Èç¹ûÎó²î³¬¹ýÁËÃÅÏÞÖµ£¬ÔòÈÏÎªµ±¿ØÖÆÁ¿µÚÒ»´Îµ½´ï¸ø¶¨ÖµÊ±£¬Ó¦¸Ã²ÉÈ¡ÏÂÃæµÄ Ò
             -ÖÖÆ³¬µ÷ µÄ´ëÊ©
 255   2              }
 256   1              else if(iError<-CONFIG_PID_FUZZY_EMAX)
 257   1              {
 258   2                      structpid->pwm_out=0;
 259   2                      pwm_var = 0;
 260   2              }
 261   1              else if( fabs(iError) < CONFIG_PID_FUZZY_EMIN ) //Îó²îµÄ·§Öµ(ËÀÇø¿ØÖÆ??)
 262   1              {
 263   2                      pwm_var = 0;
 264   2              }
 265   1              else
 266   1              {
 267   2                      if( iError<CONFIG_PID_FUZZY_EMID && structpid->flag==1 )//µÚÒ»´Î³¬¹ý(Éè¶¨Öµ-Emid(-0.08)ÉãÊÏ¶È)£¬ÊÇÊä³öÎª
             -Áã£¬·ÀÖ¹³¬µ÷£¬Ò²¿ÉÒÔÊä³öÆäËûÖµ£¬²»ÖÁÓÚÌ«Ð¡¶øÒýÆðÕðµ´
 268   2                      {
 269   3                              structpid->pwm_out=0;
 270   3                              structpid->flag=0;
 271   3                      }
 272   2                      else if( -iError>CONFIG_PID_FUZZY_EMID)//³¬¹ý(Éè¶¨+Emid(+0.08)ÉãÊÏ¶È)
 273   2                      {
 274   3                              pwm_var=-1;
 275   3                      }
 276   2                      else
 277   2                      {
 278   3                              //ÔöÁ¿¼ÆËã
 279   3                              pwm_var=(structpid->K1 * iError  //e[k]
 280   3                              + structpid->K2 * structpid->LastError  //e[k-1]
 281   3                              + structpid->K3 * structpid->PrevError);        //e[k-2]
 282   3                      }
 283   2                      if(pwm_var >= CONFIG_PID_FUZZY_UMAX)
 284   2                              pwm_var = CONFIG_PID_FUZZY_UMAX;      //µ÷ÕûÖµÏÞ·ù£¬·ÀÖ¹»ý·Ö±¥ºÍ
 285   2                      if(pwm_var <= CONFIG_PID_FUZZY_UMIN)
 286   2                              pwm_var = CONFIG_PID_FUZZY_UMIN;        //µ÷ÕûÖµÏÞ·ù£¬·ÀÖ¹»ý·Ö±¥ºÍ
 287   2      
 288   2              }
 289   1              structpid->PrevError = structpid->LastError;
 290   1              structpid->LastError = iError;
 291   1              
 292   1              structpid->pwm_out += 360*pwm_var;        //µ÷ÕûPWMÊä³ö
 293   1        
 294   1              if(structpid->pwm_out > CONFIG_PID_FUZZY_PMAX)
 295   1                      structpid->pwm_out = CONFIG_PID_FUZZY_PMAX;    //Êä³öÖµÏÞ·ù
 296   1              if(structpid->pwm_out < CONFIG_PID_FUZZY_PMIN)
 297   1                      structpid->pwm_out = CONFIG_PID_FUZZY_PMIN;    //Êä³öÖµÏÞ·ù
 298   1              return (int16_t)(structpid->pwm_out); // Î¢·ÖÏî
 299   1      }
C51 COMPILER V9.57.0.0   PIDFUZZY                                                          05/07/2018 22:16:18 PAGE 6   

 300          
 301          void pidFuzzySet(pidFuzzy_t *structpid, fp32_t Kp, fp32_t Ki, fp32_t Kd, fp32_t T)
 302          {
 303   1              (*structpid).Kp=Kp;//Kp*(1+(Td/T));
 304   1              (*structpid).Ki=Ki;
 305   1              (*structpid).Kd=Kd;
 306   1              (*structpid).T=T;
 307   1              
 308   1              structpid->K1 = structpid->Kp * (1 + structpid->Ki + structpid->Kd);
 309   1              structpid->K2 = -(structpid->Kp + 2 * structpid->Kp * structpid->Kd);
 310   1              structpid->K3 = structpid->Kp * structpid->Kd;
 311   1      }
 312          
 313          void pidFuzzyInit(pidFuzzy_t *structpid)
 314          {
 315   1              pidFuzzySet(structpid, 8.3, 1.2, 0,1);
 316   1              structpid->flag=0;
 317   1              structpid->pwm_out=0;
 318   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   5648    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    298     431
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
