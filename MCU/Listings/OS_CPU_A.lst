A51 MACRO ASSEMBLER  OS_CPU_A                                                             04/29/2018 00:16:07 PAGE     1


MACRO ASSEMBLER A51 V8.2.7.0
OBJECT MODULE PLACED IN .\Objects\OS_CPU_A.obj
ASSEMBLER INVOKED BY: C:\Keil_v5\C51\BIN\A51.EXE uCOSII\OS_CPU_A.ASM SET(LARGE) DEBUG PRINT(.\Listings\OS_CPU_A.lst) OBJ
                      ECT(.\Objects\OS_CPU_A.obj) EP

LOC  OBJ            LINE     SOURCE

                       1     ;/*
                       2     ;******************************************************************************************
                             ***************
                       3     ;*                                               uC/OS-II
                       4     ;*                                                µ ±ƒ⁄∫À
                       5     ;*
                       6     ;*                        (c) Copyright 1992-1998, Jean J. Labrosse, Plantation, FL
                       7     ;*                                               ∞Ê»®À˘”–
                       8     ;*
                       9     ;*                                            MCU-51 ◊®”√¥˙¬Î
                      10     ;*                                           KEIL C51¥Ûƒ£ Ω±‡“Î
                      11     ;*
                      12     ;* Œƒº˛√˚ : OS_CPU_A.ASM
                      13     ;* ◊˜’ﬂ   : Jean J. Labrosse
                      14     ;* ∏ƒ±‡   : —Ó“Ÿ gdtyy@ri.gdt.com.cn æﬁ¡˙π´ÀæœµÕ≥ºØ≥…ø™∑¢≤ø 2002.09.27
                      15     ;******************************************************************************************
                             ***************
                      16     ;*/
                      17     
                      18     ;Œ±÷∏¡ÓœÍœ∏”√∑®«Î≤ÈA51.PDFŒƒº˛
                      19     ;≥Ã–ÚΩ·ππœÍº˚°∂uC/OS-II°∑193-198“≥
                      20     
                      21     ;≤ª”√¥À”Ôæ‰£°£°£° $CASE    ;±Í∫≈∫Õ±‰¡ø√˚«¯∑÷¥Û–°–¥
                      22     
                      23     $nomod51 
  00AF                24     EA      BIT     0A8H.7
  0081                25     SP      DATA    081H
  00F0                26     B       DATA    0F0H
  00E0                27     ACC     DATA    0E0H
  0083                28     DPH     DATA    083H
  0082                29     DPL     DATA    082H
  00D0                30     PSW     DATA    0D0H
  008C                31     TR0     BIT     088H.4
  008C                32     TH0     DATA    08CH
  008A                33     TL0     DATA    08AH
                      34     
                      35             NAME OS_CPU_A    ;ƒ£øÈ√˚
                      36             
                      37     ;∂®“Â÷ÿ∂®Œª∂Œ
                      38     ?PR?OSStartHighRdy?OS_CPU_A    SEGMENT CODE
                      39     ?PR?OSCtxSw?OS_CPU_A           SEGMENT CODE
                      40     ?PR?OSIntCtxSw?OS_CPU_A        SEGMENT CODE
                      41     ?PR?OSTickISR?OS_CPU_A         SEGMENT CODE
                      42     
                      43     ;?PR?_?serial?OS_CPU_A          SEGMENT CODE
                      44             
                      45     ;…˘√˜“”√»´æ÷±‰¡ø∫ÕÕ‚≤ø◊”≥Ã–Ú
                      46     ;        EXTRN DATA  (?C_XBP)     ;∑¬’Ê∂—’ª÷∏’Î”√”⁄÷ÿ»Îæ÷≤ø±‰¡ø±£¥Ê
                      47     
                      48             EXTRN IDATA (OSTCBCur)
                      49             EXTRN IDATA (OSTCBHighRdy)
                      50             EXTRN IDATA (OSRunning)
                      51             EXTRN IDATA (OSPrioCur)
                      52             EXTRN IDATA (OSPrioHighRdy)
                      53         
                      54             EXTRN CODE  (OSTaskSwHook)
                      55             ;EXTRN CODE  (serial)
A51 MACRO ASSEMBLER  OS_CPU_A                                                             04/29/2018 00:16:07 PAGE     2

                      56             EXTRN CODE  (OSIntEnter)
                      57             EXTRN CODE  (OSIntExit)
                      58             EXTRN CODE  (OSTimeTick)        
                      59                 
                      60     ;∂‘Õ‚…˘√˜4∏ˆ≤ªø…÷ÿ»Î∫Ø 
                      61             PUBLIC OSStartHighRdy
                      62             PUBLIC OSCtxSw
                      63             PUBLIC OSIntCtxSw
                      64             PUBLIC OSTickISR
                      65             
                      66             ;PUBLIC SerialISR        
                      67         
                      68     ;∑÷≈‰∂—’ªø’º‰°£÷ªπÿ–ƒ¥Û–°£¨∂—’ª∆µ„”…keilæˆ∂®£¨Õ®π±Í∫≈ø…“‘ªÒµ√keil∑÷≈‰µƒSP∆µ„°£
                      69     ?STACK SEGMENT IDATA
----                  70             RSEG ?STACK
0000                  71     OSStack:
                      72             ;DS 40H
  FFFF                73     OSStkStart IDATA OSStack-1
                      74     
                      75     ;∂®“Â—π’ª≥ˆ’ª∫Í
                      76     PUSHALL    MACRO
                      77             PUSH PSW
                      78             PUSH ACC
                      79             PUSH B
                      80             PUSH DPL
                      81             PUSH DPH
                      82             MOV  A,R0   ;R0-R7»Î’ª
                      83             PUSH ACC
                      84             MOV  A,R1
                      85             PUSH ACC
                      86             MOV  A,R2
                      87             PUSH ACC
                      88             MOV  A,R3
                      89             PUSH ACC
                      90             MOV  A,R4
                      91             PUSH ACC
                      92             MOV  A,R5
                      93             PUSH ACC
                      94             MOV  A,R6
                      95             PUSH ACC
                      96             MOV  A,R7
                      97             PUSH ACC
                      98             ;PUSH SP    ;≤ª±ÿ±£¥ÊSP£¨»ŒŒÒ«–ªª ±”…œ‡”¶≥Ã–Úµ˜’˚
                      99             ENDM
                     100         
                     101     POPALL    MACRO
                     102             ;POP  ACC   ;≤ª±ÿ±£¥ÊSP£¨»ŒŒÒ«–ªª ±”…œ‡”¶≥Ã–Úµ˜’˚
                     103             POP  ACC    ;R0-R7≥ˆ’ª
                     104             MOV  R7,A
                     105             POP  ACC
                     106             MOV  R6,A
                     107             POP  ACC
                     108             MOV  R5,A
                     109             POP  ACC
                     110             MOV  R4,A
                     111             POP  ACC
                     112             MOV  R3,A
                     113             POP  ACC
                     114             MOV  R2,A
                     115             POP  ACC
                     116             MOV  R1,A
                     117             POP  ACC
                     118             MOV  R0,A
                     119             POP  DPH
                     120             POP  DPL
                     121             POP  B
A51 MACRO ASSEMBLER  OS_CPU_A                                                             04/29/2018 00:16:07 PAGE     3

                     122             POP  ACC
                     123             POP  PSW
                     124             ENDM
                     125         
                     126     ;◊”≥Ã–Ú
                     127     ;-------------------------------------------------------------------------
----                 128             RSEG ?PR?OSStartHighRdy?OS_CPU_A
0000                 129     OSStartHighRdy:
                     130             USING 0    ;…œµÁ∫Û51◊‘∂Øπÿ÷–∂œ£¨¥À¥¶≤ª±ÿ”√CLR EA÷∏¡Ó£¨“ÚŒ™µΩ¥À¥¶ªπŒ¥ø™÷–∂œ£¨±æ≥Ã–ÚÕ
                             À≥ˆ∫Û£¨ø™÷–∂œ°£
0000 120000   F      131             LCALL OSTaskSwHook
                     132     
0003                 133     OSCtxSw_in:
                     134         
                     135             ;OSTCBCur ===> DPTR  ªÒµ√µ±«∞TCB÷∏’Î£¨œÍº˚C51.PDFµ⁄178“≥
0003 7800     F      136             MOV  R0,#LOW (OSTCBCur) ;ªÒµ√OSTCBCur÷∏’ÎµÕµÿ÷∑£¨÷∏’Î’º3◊÷Ω⁄°£+0¿‡–Õ+1∏ﬂ8Œª æ›+2µÕ8
                             Œª æ›
0005 08              137             INC  R0
0006 8683            138             MOV  DPH,@R0    ;»´æ÷±‰¡øOSTCBCur‘⁄IDATA÷–
0008 08              139             INC  R0
0009 8682            140             MOV  DPL,@R0
                     141         
                     142             ;OSTCBCur->OSTCBStkPtr ===> DPTR  ªÒµ√”√ªß∂—’ª÷∏’Î
000B A3              143             INC  DPTR        ;÷∏’Î’º3◊÷Ω⁄°£+0¿‡–Õ+1∏ﬂ8Œª æ›+2µÕ8Œª æ›
000C E0              144             MOVX A,@DPTR     ;.OSTCBStkPtr «void÷∏’Î
000D F8              145             MOV  R0,A
000E A3              146             INC  DPTR
000F E0              147             MOVX A,@DPTR
0010 F9              148             MOV  R1,A
0011 8883            149             MOV  DPH,R0
0013 8982            150             MOV  DPL,R1
                     151         
                     152             ;*UserStkPtr ===> R5  ”√ªß∂—’ª∆ ºµÿ÷∑ƒ⁄»›(º¥”√ªß∂—’ª≥§∂»∑≈‘⁄¥À¥¶)  œÍº˚ŒƒµµÀµ√˜  ÷
                             ∏’Î”√∑®œÍº˚C51.PDFµ⁄178“≥    
0015 E0              153             MOVX A,@DPTR     ;”√ªß∂—’ª÷– «unsigned char¿‡–Õ æ›
0016 FD              154             MOV  R5,A        ;R5=”√ªß∂—’ª≥§∂»
                     155         
                     156             ;ª÷∏¥œ÷≥°∂—’ªƒ⁄»›
0017 7800     F      157             MOV  R0,#OSStkStart
                     158             
0019                 159     restore_stack:
                     160         
0019 A3              161             INC  DPTR
001A 08              162             INC  R0
001B E0              163             MOVX A,@DPTR
001C F6              164             MOV  @R0,A
001D DDFA            165             DJNZ R5,restore_stack
                     166         
                     167             ;ª÷∏¥∂—’ª÷∏’ÎSP
001F 8881            168             MOV  SP,R0
                     169         
                     170             ;ª÷∏¥∑¬’Ê∂—’ª÷∏’Î?C_XBP        
                     171     ;        INC  DPTR
                     172     ;        MOVX A,@DPTR
                     173     ;        MOV  ?C_XBP,A    ;?C_XBP ∑¬’Ê∂—’ª÷∏’Î∏ﬂ8Œª
                     174     ;        INC  DPTR
                     175     ;        MOVX A,@DPTR
                     176     ;        MOV  ?C_XBP+1,A  ;?C_XBP ∑¬’Ê∂—’ª÷∏’ÎµÕ8Œª
                     177         
                     178             ;OSRunning=TRUE
0021 7800     F      179             MOV  R0,#LOW (OSRunning)
0023 7601            180             MOV  @R0,#01
                     181         
                     182             POPALL
0047 D2AF            205             SETB EA    ;ø™÷–∂œ
0049 32              206             RETI
A51 MACRO ASSEMBLER  OS_CPU_A                                                             04/29/2018 00:16:07 PAGE     4

                     207     ;-------------------------------------------------------------------------
----                 208             RSEG ?PR?OSCtxSw?OS_CPU_A
0000                 209     OSCtxSw:    
                     210             PUSHALL
                     233         
0022                 234     OSIntCtxSw_in:
                     235         
                     236             ;ªÒµ√∂—’ª≥§∂»∫Õ∆÷∑
0022 E581            237             MOV  A,SP
0024 C3              238             CLR  C
0025 9400     F      239             SUBB A,#OSStkStart
0027 FD              240             MOV  R5,A     ;ªÒµ√∂—’ª≥§∂»        
                     241         
                     242             ;OSTCBCur ===> DPTR  ªÒµ√µ±«∞TCB÷∏’Î£¨œÍº˚C51.PDFµ⁄178“≥
0028 7800     F      243             MOV  R0,#LOW (OSTCBCur) ;ªÒµ√OSTCBCur÷∏’ÎµÕµÿ÷∑£¨÷∏’Î’º3◊÷Ω⁄°£+0¿‡–Õ+1∏ﬂ8Œª æ›+2µÕ8
                             Œª æ›
002A 08              244             INC  R0
002B 8683            245             MOV  DPH,@R0    ;»´æ÷±‰¡øOSTCBCur‘⁄IDATA÷–
002D 08              246             INC  R0
002E 8682            247             MOV  DPL,@R0
                     248         
                     249             ;OSTCBCur->OSTCBStkPtr ===> DPTR  ªÒµ√”√ªß∂—’ª÷∏’Î
0030 A3              250             INC  DPTR        ;÷∏’Î’º3◊÷Ω⁄°£+0¿‡–Õ+1∏ﬂ8Œª æ›+2µÕ8Œª æ›
0031 E0              251             MOVX A,@DPTR     ;.OSTCBStkPtr «void÷∏’Î
0032 F8              252             MOV  R0,A
0033 A3              253             INC  DPTR
0034 E0              254             MOVX A,@DPTR
0035 F9              255             MOV  R1,A
0036 8883            256             MOV  DPH,R0
0038 8982            257             MOV  DPL,R1
                     258             
                     259             ;±£¥Ê∂—’ª≥§∂»
003A ED              260             MOV  A,R5
003B F0              261             MOVX @DPTR,A
                     262         
003C 7800     F      263             MOV  R0,#OSStkStart  ;ªÒµ√∂—’ª∆÷∑
003E                 264     save_stack:
                     265         
003E A3              266             INC  DPTR
003F 08              267             INC  R0
0040 E6              268             MOV  A,@R0
0041 F0              269             MOVX @DPTR,A
0042 DDFA            270             DJNZ R5,save_stack
                     271             
                     272             ;±£¥Ê∑¬’Ê∂—’ª÷∏’Î?C_XBP
                     273     ;        INC  DPTR
                     274     ;        MOV  A,?C_XBP    ;?C_XBP ∑¬’Ê∂—’ª÷∏’Î∏ﬂ8Œª
                     275     ;        MOVX @DPTR,A
                     276     ;        INC  DPTR
                     277     ;        MOV  A,?C_XBP+1  ;?C_XBP ∑¬’Ê∂—’ª÷∏’ÎµÕ8Œª
                     278     ;        MOVX @DPTR,A        
                     279         
                     280             ;µ˜”√”√ªß≥Ã–Ú
0044 120000   F      281             LCALL OSTaskSwHook
                     282             
                     283             ;OSTCBCur = OSTCBHighRdy
0047 7800     F      284             MOV  R0,#OSTCBCur
0049 7900     F      285             MOV  R1,#OSTCBHighRdy
004B E7              286             MOV  A,@R1
004C F6              287             MOV  @R0,A
004D 08              288             INC  R0
004E 09              289             INC  R1
004F E7              290             MOV  A,@R1
0050 F6              291             MOV  @R0,A
0051 08              292             INC  R0
0052 09              293             INC  R1
A51 MACRO ASSEMBLER  OS_CPU_A                                                             04/29/2018 00:16:07 PAGE     5

0053 E7              294             MOV  A,@R1
0054 F6              295             MOV  @R0,A
                     296                     
                     297             ;OSPrioCur = OSPrioHighRdy   π”√’‚¡Ω∏ˆ±‰¡ø÷˜“™ƒøµƒ «Œ™¡À π÷∏’Î±»Ωœ±‰Œ™◊÷Ω⁄±»Ωœ£¨“‘±
                             „Ω⁄ ° ±º‰°£
0055 7800     F      298             MOV  R0,#OSPrioCur
0057 7900     F      299             MOV  R1,#OSPrioHighRdy
0059 E7              300             MOV  A,@R1
005A F6              301             MOV  @R0,A
                     302             
005B 020000   F      303             LJMP OSCtxSw_in
                     304     ;-------------------------------------------------------------------------
----                 305             RSEG ?PR?OSIntCtxSw?OS_CPU_A
                     306             
0000                 307     OSIntCtxSw:
                     308     
                     309             ;µ˜’˚SP÷∏’Î»•µÙ‘⁄µ˜”√OSIntExit(),OSIntCtxSw()π≥Ã÷–—π»Î∂—’ªµƒ∂‡”‡ƒ⁄»›
                     310             ;SP=SP-4
                     311     
0000 E581            312             MOV  A,SP
0002 C3              313             CLR  C
0003 9404            314             SUBB A,#4
0005 F581            315             MOV  SP,A
                     316             
0007 020000   F      317             LJMP OSIntCtxSw_in
                     318     ;-------------------------------------------------------------------------
----                 319             CSEG AT 000BH    ;OSTickISR
000B 020000   F      320             LJMP OSTickISR   ; π”√∂® ±∆˜0
----                 321             RSEG ?PR?OSTickISR?OS_CPU_A
                     322     
0000                 323     OSTickISR:        
                     324             
                     325             USING 0        
                     326             PUSHALL
                     349             
0022 C28C            350             CLR  TR0
0024 758CDB          351             MOV  TH0,#0DBH    ;∂®“ÂTick=200¥Œ/√Î(º¥0.005√Î/¥Œ)°£æß’Ò∆µ¬ Œ™22.1184MHZ
0027 758AF6          352             MOV  TL0,#0F6H    ;OS_CPU_C.C  ∫Õ  OS_TICKS_PER_SEC
002A D28C            353             SETB TR0
                     354             
002C 120000   F      355             LCALL OSIntEnter
002F 120000   F      356             LCALL OSTimeTick
0032 120000   F      357             LCALL OSIntExit
                     358             POPALL        
0057 32              381             RETI
                     382     ;-------------------------------------------------------------------------
                     383     ;        CSEG AT 0023H    ;¥Æø⁄÷–∂œ
                     384     ;        LJMP SerialISR   ;π§◊˜”⁄œµÕ≥Ã¨£¨Œﬁ»ŒŒÒ«–ªª°£
                     385     ;        RSEG ?PR?_?serial?OS_CPU_A
                     386             
                     387     ;SerialISR:
                     388             
                     389     ;        USING 0        
                     390     ;        PUSHALL
                     391     ;        CLR  EA
                     392     ;        LCALL serial        
                     393     ;        SETB EA
                     394     ;        POPALL        
                     395     ;        RETI
                     396     ;-------------------------------------------------------------------------
                     397              END
                             ;-------------------------------------------------------------------------
A51 MACRO ASSEMBLER  OS_CPU_A                                                             04/29/2018 00:16:07 PAGE     6

SYMBOL TABLE LISTING
------ ----- -------


N A M E                      T Y P E  V A L U E   ATTRIBUTES

?PR?OSCTXSW?OS_CPU_A. . . .  C SEG    005EH       REL=UNIT
?PR?OSINTCTXSW?OS_CPU_A . .  C SEG    000AH       REL=UNIT
?PR?OSSTARTHIGHRDY?OS_CPU_A  C SEG    004AH       REL=UNIT
?PR?OSTICKISR?OS_CPU_A. . .  C SEG    0058H       REL=UNIT
?STACK. . . . . . . . . . .  I SEG    0000H       REL=UNIT
ACC . . . . . . . . . . . .  D ADDR   00E0H   A   
B . . . . . . . . . . . . .  D ADDR   00F0H   A   
DPH . . . . . . . . . . . .  D ADDR   0083H   A   
DPL . . . . . . . . . . . .  D ADDR   0082H   A   
EA. . . . . . . . . . . . .  B ADDR   00A8H.7 A   
OSCTXSW . . . . . . . . . .  C ADDR   0000H   R   SEG=?PR?OSCTXSW?OS_CPU_A
OSCTXSW_IN. . . . . . . . .  C ADDR   0003H   R   SEG=?PR?OSSTARTHIGHRDY?OS_CPU_A
OSINTCTXSW. . . . . . . . .  C ADDR   0000H   R   SEG=?PR?OSINTCTXSW?OS_CPU_A
OSINTCTXSW_IN . . . . . . .  C ADDR   0022H   R   SEG=?PR?OSCTXSW?OS_CPU_A
OSINTENTER. . . . . . . . .  C ADDR   -----       EXT
OSINTEXIT . . . . . . . . .  C ADDR   -----       EXT
OSPRIOCUR . . . . . . . . .  I ADDR   -----       EXT
OSPRIOHIGHRDY . . . . . . .  I ADDR   -----       EXT
OSRUNNING . . . . . . . . .  I ADDR   -----       EXT
OSSTACK . . . . . . . . . .  I ADDR   0000H   R   SEG=?STACK
OSSTARTHIGHRDY. . . . . . .  C ADDR   0000H   R   SEG=?PR?OSSTARTHIGHRDY?OS_CPU_A
OSSTKSTART. . . . . . . . .  I ADDR   FFFFH   R   SEG=?STACK
OSTASKSWHOOK. . . . . . . .  C ADDR   -----       EXT
OSTCBCUR. . . . . . . . . .  I ADDR   -----       EXT
OSTCBHIGHRDY. . . . . . . .  I ADDR   -----       EXT
OSTICKISR . . . . . . . . .  C ADDR   0000H   R   SEG=?PR?OSTICKISR?OS_CPU_A
OSTIMETICK. . . . . . . . .  C ADDR   -----       EXT
OS_CPU_A. . . . . . . . . .  N NUMB   -----       
PSW . . . . . . . . . . . .  D ADDR   00D0H   A   
RESTORE_STACK . . . . . . .  C ADDR   0019H   R   SEG=?PR?OSSTARTHIGHRDY?OS_CPU_A
SAVE_STACK. . . . . . . . .  C ADDR   003EH   R   SEG=?PR?OSCTXSW?OS_CPU_A
SP. . . . . . . . . . . . .  D ADDR   0081H   A   
TH0 . . . . . . . . . . . .  D ADDR   008CH   A   
TL0 . . . . . . . . . . . .  D ADDR   008AH   A   
TR0 . . . . . . . . . . . .  B ADDR   0088H.4 A   


REGISTER BANK(S) USED: 0 


ASSEMBLY COMPLETE.  0 WARNING(S), 0 ERROR(S)
