C51 COMPILER V9.59.0.0   I2C4                                                              12/15/2018 23:49:20 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE I2C4
OBJECT MODULE PLACED IN .\Objects\i2c4.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Driver\i2c4.c COMPACT OPTIMIZE(8,SPEED) REGFILE(.\Objects\dwLaser_F020.O
                    -RC) BROWSE ORDER INCDIR(.\Lib;.\Driver;.\MainApp;.\Modbus) DEBUG OBJECTEXTEND PRINT(.\Listings\i2c4.lst) OBJECT(.\Object
                    -s\i2c4.obj)

line level    source

   1          #include "i2c4.h"
   2          /*****************************************************************************/                         
   3          /*****************************************************************************/
   4          void iic4Init(void){
   5   1      
   6   1      }
   7          static void setSCL(uint8_t s){
   8   1              if(s)
   9   1                      P4 |= 1 << 5;
*** ERROR C202 IN LINE 9 OF Driver\i2c4.c: 'P4': undefined identifier
  10   1              else
  11   1                      P4 &= ~(1 << 5);
*** ERROR C202 IN LINE 11 OF Driver\i2c4.c: 'P4': undefined identifier
  12   1      }
  13          static void setSDA(uint8_t s){
  14   1              if(s)
  15   1                      P4 |= 1 << 4;
*** ERROR C202 IN LINE 15 OF Driver\i2c4.c: 'P4': undefined identifier
  16   1              else
  17   1                      P4 &= ~(1 << 4);
*** ERROR C202 IN LINE 17 OF Driver\i2c4.c: 'P4': undefined identifier
  18   1      }
  19          static uint8_t getSCL(void){
  20   1              return ((P4 >> 5) & 0x01);
*** ERROR C202 IN LINE 20 OF Driver\i2c4.c: 'P4': undefined identifier
  21   1      }
  22          static uint8_t getSDA(void){
  23   1              return ((P4 >> 4) & 0x01); 
*** ERROR C202 IN LINE 23 OF Driver\i2c4.c: 'P4': undefined identifier
  24   1      }
  25          void iic4Start(void){//产生IIC起始信号
  26   1              setSDA(1);                
  27   1              setSCL(1);
  28   1              delayUs(CONFIG_EPROM_FREQ);
  29   1              setSDA(0);//START:when CLK is high,DATA change form high to low 
  30   1              delayUs(CONFIG_EPROM_FREQ);
  31   1              setSCL(0);//钳住I2C总线，准备发送或接收数据 
  32   1      }         
  33          void iic4Stop(void){//产生IIC停止信号
  34   1              setSCL(0);
  35   1              setSDA(0);//STOP:when CLK is high DATA change form low to high
  36   1              delayUs(CONFIG_EPROM_FREQ);
  37   1              setSCL(1); 
  38   1              setSDA(1);//发送I2C总线结束信号
  39   1              delayUs(CONFIG_EPROM_FREQ);                                                             
  40   1      }
  41          
  42          uint8_t iic4WaitAck(void){
  43   1      //发送数据后，等待应答信号到来
  44   1      //返回值：1，接收应答失败，IIC直接退出
  45   1      //        0，接收应答成功，什么都不做
  46   1              uint8_t ucErrTime=0;  
  47   1              setSDA(1);
C51 COMPILER V9.59.0.0   I2C4                                                              12/15/2018 23:49:20 PAGE 2   

  48   1              delayUs(1);        
  49   1              setSCL(1);
  50   1              delayUs(1);      
  51   1              while(getSDA()){
  52   2                      ucErrTime ++;
  53   2                      if(ucErrTime >= 250){
  54   3                              iic4Stop();
  55   3                              return 1;
  56   3                      }
  57   2              }
  58   1              setSCL(0);    //时钟输出0          
  59   1              return 0;  
  60   1      }
  61          void iic4Ack(void){//产生ACK应答
  62   1              setSCL(0);
  63   1              setSDA(0);
  64   1              delayUs(CONFIG_EPROM_FREQ);
  65   1              setSCL(1);
  66   1              delayUs(CONFIG_EPROM_FREQ);
  67   1              setSCL(0);
  68   1      }
  69                      
  70          void iic4NAck(void){//不产生ACK应答     
  71   1              setSCL(0);
  72   1              setSDA(1);
  73   1              delayUs(CONFIG_EPROM_FREQ);
  74   1              setSCL(1);
  75   1              delayUs(CONFIG_EPROM_FREQ);
  76   1              setSCL(0);
  77   1      }                                                                                 
  78          void iic4SendByte(uint8_t txd){//IIC发送一个字节
  79   1      //返回从机有无应答
  80   1      //1，有应答
  81   1      //0，无应答                        
  82   1          uint8_t t;              
  83   1          setSCL(0);//拉低时钟开始数据传输
  84   1          for(t = 0;t < 8;t ++)
  85   1          {              
  86   2              //SDA0=(txd&0x80)>>7;
  87   2                      if((txd & 0x80) >> 7)
  88   2                              setSDA(1);
  89   2                      else
  90   2                              setSDA(0);
  91   2                      txd <<= 1;        
  92   2                      delayUs(CONFIG_EPROM_FREQ);
  93   2                      setSCL(1);
  94   2                      delayUs(CONFIG_EPROM_FREQ); 
  95   2                      setSCL(0);      
  96   2                      delayUs(CONFIG_EPROM_FREQ);
  97   2          }    
  98   1      }           
  99            
 100          uint8_t iic4ReadByte(uint8_t ack){//读1个字节，ack=1时，发送ACK，ack=0，发送nACK 
 101   1              uint8_t i, receive=0;
 102   1          for(i=0;i<8;i++ ){
 103   2              setSCL(0); 
 104   2              delayUs(CONFIG_EPROM_FREQ);
 105   2                      setSCL(1);
 106   2              receive <<= 1;
 107   2              if(getSDA())
 108   2                              receive ++;   
 109   2                      delayUs(CONFIG_EPROM_FREQ); 
C51 COMPILER V9.59.0.0   I2C4                                                              12/15/2018 23:49:20 PAGE 3   

 110   2          }                                    
 111   1          if(!ack)
 112   1              iic4NAck();        //发送nACK
 113   1          else
 114   1              iic4Ack();         //发送ACK   
 115   1          return receive;
 116   1      }

C51 COMPILATION COMPLETE.  0 WARNING(S),  6 ERROR(S)
