C51 COMPILER V9.59.0.0   I2C0                                                              01/29/2019 14:24:57 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE I2C0
OBJECT MODULE PLACED IN .\Objects\i2c0.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE Driver\i2c0.c OPTIMIZE(8,SPEED) BROWSE INCDIR(.\Lib;.\Driver;.\MainApp\s
                    -Plc;.\MainApp\sPlc_Port;.\Modbus;.\MainApp) DEBUG OBJECTEXTEND CODE LISTINCLUDE SYMBOLS PRINT(.\Listings\i2c0.lst) PREPR
                    -INT(.\Listings\i2c0.i) OBJECT(.\Objects\i2c0.obj)

line level    source

   1          #include "i2c0.h"
   1      =1  #ifndef __I2C0_H__
   2      =1  #define __I2C0_H__
   3      =1  /*****************************************************************************/
   4      =1  #include "appConfig.h"
   1      =2  #ifndef __APPCONFIG_H__
   2      =2  #define __APPCONFIG_H__
   3      =2  /*****************************************************************************/
   4      =2  #define DEBUG_LED_ON                                            0
   5      =2  #define DEBUG_LED_OFF                                           1
   6      =2  <<<<<<< HEAD
*** ERROR C141 IN LINE 6 OF .\MainApp\appConfig.h: syntax error near '<<', expected 'hdata'
   7      =2  #define CONFIG_SYSCLK                       (48000000L)//F580内部48M
   8      =2  =======
*** ERROR C129 IN LINE 8 OF .\MainApp\appConfig.h: missing ';' before '=='
   9      =2  #define CONFIG_SYSCLK                       (22118400L)
*** WARNING C317 IN LINE 9 OF .\MainApp\appConfig.h: attempt to redefine macro 'CONFIG_SYSCLK'
  10      =2  #ifdef C8051F020
           =2 >>>>>>> MCFCL_25MP
           =2 #define SAR_CLK                                                 2000000L//ADC0时钟 <2.5MHz
           =2 #define CONFIG_DEBUG                        0//调试功能
           =2 <<<<<<< HEAD
           =2 #define CONFIG_USING_WDT                                        0//使能看门狗
           =2 #define CONFIG_USING_RESET                                      0//使能PLC复位MCU功能
           =2 #define CONFIG_LADDER_SECTORS_START                     64//指令起始地址
           =2 #define CONFIG_LADDER_SECTORS_END                       128//指令结束地址
           =2 #define CONFIG_LASERTIMER_OVERFLOW_US           1000L//定时器周期 1mS
           =2 #define CONFIG_VERSION                                          0x0001
           =2 #define CONFIG_CHECK_CODE                                       0x5A7E
           =2 
           =2 =======
           =2 >>>>>>> MCFCL_25MP
           =2 /*****************************************************************************/
           =2 #define CONFIG_UART0_BAUDRATE                           115200//串口波特率
           =2 #define CONFIG_UART0_PARITY                                     NONE
           =2 #define CONFIG_UART0_STOPBIT                            1
           =2 #define CONFIG_UART0_DATABIT                            8
           =2 
           =2 #define CONFIG_UART1_BAUDRATE                           9600//串口波特率
           =2 #define CONFIG_UART1_PARITY                                     NONE
           =2 #define CONFIG_UART1_STOPBIT                            1
           =2 #define CONFIG_UART1_DATABIT                            8
           =2 /*****************************************************************************/
           =2 <<<<<<< HEAD
           =2 #define CONFIG_I2C0_FREQ                                        1            
           =2 #define CONFIG_I2C1_FREQ                                        1
           =2 #define CONFIG_I2C2_FREQ                                        1
           =2 #define CONFIG_I2C3_FREQ                                        1
           =2 #define CONFIG_I2C4_FREQ                                        1
           =2 =======
           =2 #define CONFIG_I2C0_FREQ                                        1 
           =2 >>>>>>> MCFCL_25MP
           =2 #define CONFIG_I2C_WAITACT_TIME                         250
C51 COMPILER V9.59.0.0   I2C0                                                              01/29/2019 14:24:57 PAGE 2   

           =2 /*****************************************************************************/
           =2 #define CONFIG_EPROM_DEBUG                                      0
           =2 #define CONFIG_EPROM_SIZE                                       CONFIG_AT24C64_SIZE
           =2 #define CONFIG_AT24C02_SIZE                             256
           =2 #define CONFIG_AT24C04_SIZE                             512
           =2 #define CONFIG_AT24C08_SIZE                             1024
           =2 #define CONFIG_AT24C16_SIZE                             2048
           =2 #define CONFIG_AT24C32_SIZE                             4096
           =2 #define CONFIG_AT24C64_SIZE                                     8192
           =2 #define CONFIG_AT24C128_SIZE                            16384
           =2 #define CONFIG_AT24C256_SIZE                            32768
           =2 #define CONFIG_EPROM_ADDRESS                            0x50
           =2 #define CONFIG_EPROM_FRAM                                       0//铁电存储体无写入等待
           =2 <<<<<<< HEAD
           =2 #define CONFIG_EPROM_FREQ                                       1//
           =2 #define CONFIG_EPROM_PAGEWRITE                          0//页写入
           =2 /*****************************************************************************/
           =2 #define CONFIG_USE_IPID                                         1//使能IPID温度控制
           =2 /*****************************************************************************/
           =2 #define CONFIG_USE_HWVER_SHOW                           1//使能固件版本显示
           =2 #define CONFIG_USE_MPD1_SHOW                            1//使能MPD1测量显示
           =2 #define CONFIG_USE_MPD2_SHOW                            1//使能MPD2测量显示
           =2 #define CONFIG_USE_FBS1                                         1//使能FBS1检测
           =2 #define CONFIG_USE_FBS2                                         1//使能FBS2检测
           =2 #define CONFIG_USE_LASER_TEMP                           1//使能激光器温度显示
           =2 #define CONFIG_USE_RADIATOR_TEMP                        1//使能散热器温度显示
           =2 #define CONFIG_USE_ENVI_TEMP                            1//使能环境温度显示
           =2 #define CONFIG_USE_IPID_UPDATE                          1//使能IPID参数更新功能
           =2 #define CONFIG_USE_IPID_OUTSHOW                         1//使能IPID输出显示
           =2 =======
           =2 #define CONFIG_EPROM_PAGEWRITE                          0//页写入
           =2 >>>>>>> MCFCL_25MP
           =2 /*****************************************************************************/
           =2 //SPLC设置
           =2 #define CONFIG_SPLC_ASSERT                                      1//检查地址范围
           =2 #define CONFIG_SPLC_DEV                                         0x0A01//设备号
           =2 #define CONFIG_SPLC_CLEAR_CODE                          0xA58E
           =2 #define CONFIG_SOFTPLC_HWTIME                           1000L//1mS
           =2 #define CONFIG_INPUT_FILTER_TIME                        3//输入数字滤波扫描周期 1mS * N
           =2 /*****************************************************************************/
           =2 #define CONFIG_SPLC_USING_CLEAR_NVRAM           1//启用清除NVRAM功能
           =2 /*****************************************************************************/
           =2 #define CONFIG_SPLC_USING_WDT                           1//看门狗启用
           =2 /*****************************************************************************/
           =2 #define CONFIG_SPLC_USING_IO_INPUT                      1//输入IO刷新启用
           =2 /*****************************************************************************/
           =2 #define CONFIG_SPLC_USING_IO_OUTPUT                     1//输出IO刷新启用
           =2 /*****************************************************************************/
           =2 #define CONFIG_SPLC_USING_EPROM                         1//EPROM掉电存储启用
           =2 /*****************************************************************************/
           =2 #define CONFIG_SPLC_USING_UART1                         1//UART1串口启用
           =2 #if CONFIG_SPLC_USING_UART1 == 1
           =2 #define SPLC_UART1                                                      1
           =2 #endif
           =2 /*****************************************************************************/
           =2 #define CONFIG_SPLC_USING_CADC                          1//使能ADC模块
           =2 #define CONFIG_SPLC_ADC_FILTER_TAP                      14//ADC位移滤波次数
           =2 #define CONFIG_SPLC_ADC_CHANNLE                         64//ADC通道数
           =2 #define CONFIG_SPLC_ADC_TEMP_SENSOR_GAIN    3330L// Temp Sensor Gain in (uV / degC)
           =2 #define CONFIG_SPLC_ADC_TEMP_SENSOR_OFFSET  856L// Temp Sensor Offset in mV
           =2 #define CONFIG_SPLC_ADC_INTERNAL_VREF           2400L// ADC Voltage Reference (mV)
           =2 #define CONFIG_SPLC_ADC_AMBIENT             25L// Ambient temp in deg C
C51 COMPILER V9.59.0.0   I2C0                                                              01/29/2019 14:24:57 PAGE 3   

           =2 /*****************************************************************************/
           =2 #define CONFIG_SPLC_USING_DAC                           1//是能DAC模块
           =2 /*****************************************************************************/
           =2 #define CONFIG_SPLC_USING_MB_RTU_SLAVE          1//是能MODBUS RTU从站
           =2 #define CONFIG_MB_RTU_SLAVE_TIMER                       1000L//1000uS
           =2 #define CONFIG_MB_RTU_SLAVE_ADDRESS                     0x01//从设备地址
           =2 #define CONFIG_MB_RTU_SLAVE_BUFFER_SIZE         256//发送接收缓冲区
           =2 #define CONFIG_MB_RTU_SLAVE_TIMEOUT                     100//接收通讯超时 10mS
           =2 #define CONFIG_MB_RTU_SLAVE_IO_DELAY            1//RX TX切换延时
           =2 /*****************************************************************************/
           =2 <<<<<<< HEAD
           =2 /*****************************************************************************/
           =2 #define DISABLE_MODBUS_SERIAL_INTERRUPT         ES0 = 0;
           =2 #define ENABLE_MODBUS_SERIAL_INTERRUPT          ES0 = 1;
           =2 #define DISABLE_INTERRUPT                                       EA = 0;
           =2 #define ENABLE_INTERRUPT                                        EA = 1;
           =2 /*****************************************************************************/
           =2 
           =2 /*****************************************************************************/
           =2 #define ID_ONLY_1_CHANNEL                                       4321
           =2 #define ID_ONLY_2_CHANNEL                                       8765
           =2 #define ID_BOTH_CHANNEL                                         9431
           =2 #define ID_LASER_MODE_CW                                        7631
           =2 #define ID_LASER_MODE_SP                                        8934
           =2 #define ID_LASER_MODE_MP                                        2453
           =2 #define ID_LASER_MODE_GP                                        3876
           =2 /*****************************************************************************/
           =2 #define FBS1_IN_PORT                                            3
           =2 #define FBS2_IN_PORT                                            2
           =2 #define COOLON_OUT_PORT                                         (1 * 8 + 3)
           =2 /*****************************************************************************/
           =2 //PID FUZZY 模糊PID配置
           =2 #define CONFIG_TECOUT_CYCLE                                     4000//PID输出转PWM周期
           =2 /*****************************************************************************/
           =2 =======
           =2 >>>>>>> MCFCL_25MP
           =2 /*****************************************************************************/
           =2 #define DISABLE_MODBUS_SERIAL_INTERRUPT         ES0 = 0;
           =2 #define ENABLE_MODBUS_SERIAL_INTERRUPT          ES0 = 1;
           =2 #define DISABLE_INTERRUPT                                       EA = 0;
           =2 #define ENABLE_INTERRUPT                                        EA = 1;
           =2 /*****************************************************************************/
           =2 //指示盒子
           =2 #define R_BOX_RED_SENDED                                        (R_START * 16 + 126)//190
           =2 #define R_BOX_GREEN_SENDED                                      (R_START * 16 + 127)//191
           =2 #define BOX_CMD_STX                                                     0x81
           =2 #define BOX_CMD_ETX                                                     0x84
           =2 #define BOX_SEND_BFADDR                                         (EM_START + 100)//发送缓冲区位置
           =2 #define BOX_SEND_LENGTH                                         29//发送数据量
           =2 /*****************************************************************************/
           =2 #include "stdint.h"
           =2 #include "stdbool.h"
           =2 #include "endian.h"
           =2 #include "si_toolchain.h"
           =2 #include "compiler_defs.h"
           =2 <<<<<<< HEAD
           =2 #include "C8051F580_defs.h"
           =2 =======
           =2 #include "C8051F020_defs.h"
           =2 >>>>>>> MCFCL_25MP
           =2 /*****************************************************************************/
           =2 #include <stdio.h>
C51 COMPILER V9.59.0.0   I2C0                                                              01/29/2019 14:24:57 PAGE 4   

           =2 #include <stdlib.h> 
           =2 #include <string.h>
           =2 #include <INTRINS.H>
           =2 #include <ctype.h>
           =2 #include <LIMITS.H>
           =2 #include <math.h>
           =2 <<<<<<< HEAD
           =2 /*****************************************************************************/
           =2 #include "InitDeviceF580.h"
           =2 #include "delay.h"
           =2 #include "i2c0.h"
           =2 #include "i2c1.h"
           =2 #include "i2c2.h"
           =2 #include "i2c3.h"
           =2 #include "i2c4.h"
           =2 #include "i2c5.h"
           =2 #include "i2c6.h"
           =2 #include "eprom.h"
           =2 #include "mcp47x6.h"
           =2 #include "inPca9554.h"
           =2 #include "outPca9554.h"
           =2 
           =2 =======
           =2 //#include "crc32.h"
           =2 /*****************************************************************************/
           =2 #include "InitDeviceF020.h"
           =2 #include "delay.h"
           =2 #include "i2c0.h"
           =2 #include "eprom.h"
           =2 #include "dac8568_0.h"
           =2 #include "dac8568_1.h"
           =2 #include "dac8568_2.h"
           =2 #include "dac8568_3.h"
           =2 >>>>>>> MCFCL_25MP
           =2 #if CONFIG_SPLC_USING_UART1 == 1
           =2 #include "sPlcUart.h"
           =2 #endif
           =2 #if CONFIG_SPLC_USING_CADC == 1
           =2 #include "sPlcChipAdc.h"
           =2 #endif
           =2 #if CONFIG_SPLC_USING_DAC == 1
           =2 #include "sPlcDac.h"
           =2 #endif
           =2 /*****************************************************************************/
           =2 #include "Modbus.h"
           =2 #include "ModbusPort.h"
           =2 /*****************************************************************************/
           =2 #include "sPLC.h"
           =2 <<<<<<< HEAD
           =2 #include "sPlcFun.h"
           =2 =======
           =2 #include "sPlcTimer.h"
           =2 #include "sPlcFun.h"
           =2 #include "sPlcLed.h"
           =2 #include "sPlcIo.h"
           =2 #include "sPlcWatchDog.h"
           =2 >>>>>>> MCFCL_25MP
           =2 /*****************************************************************************/
           =2 #endif
   5      =1  /*****************************************************************************/
   6      =1  
   7      =1  /*****************************************************************************/
C51 COMPILER V9.59.0.0   I2C0                                                              01/29/2019 14:24:57 PAGE 5   

   8      =1  void iic0Init(void);
   9      =1  void iic0Start(void);
  10      =1  void iic0Stop(void);
  11      =1  uint8_t iic0WaitAck(void);
  12      =1  void iic0Ack(void);
  13      =1  void iic0NAck(void);
  14      =1  void iic0SendByte(uint8_t txd);
  15      =1  uint8_t iic0ReadByte(uint8_t ack);
  16      =1  
  17      =1  #endif
  18      =1  
  19      =1  
   2          /*****************************************************************************/         
   3          /*****************************************************************************/
   4          void iic0Init(void){
   5          
   6          }
   7          static void setSCL0(uint8_t s){
   8                  if(s)
   9          <<<<<<< HEAD
  10                          P4 |= (1 << 7);
  11                  else
  12                          P4 &= ~((uint8_t)(1 << 7));
  13          }
  14          static void setSDA0(uint8_t s){
  15                  if(s)
  16                          P4 |= (uint8_t)(1 << 6);
  17                  else
  18                          P4 &= ~((uint8_t)(1 << 6));
  19          }
  20          static uint8_t getSCL0(void){
  21                  return (P4 >> 7) & 0x01;
  22          }
  23          static uint8_t getSDA0(void){
  24                  return (P4 >> 6) & 0x01;
  25          =======
  26                          P7 |= (1 << 7);
  27                  else
  28                          P7 &= ~((uint8_t)(1 << 7));
  29          }
  30          static void setSDA0(uint8_t s){
  31                  if(s)
  32                          P7 |= (uint8_t)(1 << 6);
  33                  else
  34                          P7 &= ~((uint8_t)(1 << 6));
  35          }
  36          static uint8_t getSCL0(void){
  37                  return (P7 >> 7) & 0x01;
  38          }
  39          static uint8_t getSDA0(void){
  40                  return (P7 >> 6) & 0x01;
  41          >>>>>>> MCFCL_25MP
  42          }
  43          void iic0Start(void){//产生IIC起始信号
  44                  setSDA0(1);               
  45                  setSCL0(1);
  46                  delayUs(CONFIG_I2C0_FREQ);
  47                  setSDA0(0);//START:when CLK is high,DATA change form high to low 
  48                  delayUs(CONFIG_I2C0_FREQ);
  49                  setSCL0(0);//钳住I2C总线，准备发送或接收数据 
  50          }         
  51          void iic0Stop(void){//产生IIC停止信号
C51 COMPILER V9.59.0.0   I2C0                                                              01/29/2019 14:24:57 PAGE 6   

  52                  setSCL0(0);
  53                  setSDA0(0);//STOP:when CLK is high DATA change form low to high
  54                  delayUs(CONFIG_I2C0_FREQ);
  55                  setSCL0(1); 
  56                  setSDA0(1);//发送I2C总线结束信号
  57                  delayUs(CONFIG_I2C0_FREQ);                                                              
  58          }
  59          
  60          uint8_t iic0WaitAck(void){
  61          //发送数据后，等待应答信号到来
  62          //返回值：1，接收应答失败，IIC直接退出
  63          //        0，接收应答成功，什么都不做
  64                  uint8_t ucErrTime=0;  
  65                  setSDA0(1);
  66                  delayUs(1);        
  67                  setSCL0(1);
  68                  delayUs(1);      
  69                  while(getSDA0()){
  70                          ucErrTime ++;
  71                          if(ucErrTime >= CONFIG_I2C_WAITACT_TIME){
  72                                  iic0Stop();
  73                                  return 1;
  74                          }
  75                  }
  76                  setSCL0(0);    //时钟输出0         
  77                  return 0;  
  78          }
  79          void iic0Ack(void){//产生ACK应答
  80                  setSCL0(0);
  81                  setSDA0(0);
  82                  delayUs(CONFIG_I2C0_FREQ);
  83                  setSCL0(1);
  84                  delayUs(CONFIG_I2C0_FREQ);
  85                  setSCL0(0);
  86          }
  87                      
  88          void iic0NAck(void){//不产生ACK应答     
  89                  setSCL0(0);
  90                  setSDA0(1);
  91                  delayUs(CONFIG_I2C0_FREQ);
  92                  setSCL0(1);
  93                  delayUs(CONFIG_I2C0_FREQ);
  94                  setSCL0(0);
  95          }                                                                                 
  96          void iic0SendByte(uint8_t txd){//IIC发送一个字节
  97          //返回从机有无应答
  98          //1，有应答
  99          //0，无应答                        
 100              uint8_t t;              
 101              setSCL0(0);//拉低时钟开始数据传输
 102              for(t = 0;t < 8;t ++)
 103              {              
 104                  //SDA0=(txd&0x80)>>7;
 105                          if((txd & 0x80) >> 7)
 106                                  setSDA0(1);
 107                          else
 108                                  setSDA0(0);
 109                          txd <<= 1;        
 110                          delayUs(CONFIG_I2C0_FREQ);
 111                          setSCL0(1);
 112                          delayUs(CONFIG_I2C0_FREQ); 
 113                          setSCL0(0);     
C51 COMPILER V9.59.0.0   I2C0                                                              01/29/2019 14:24:57 PAGE 7   

 114                          delayUs(CONFIG_I2C0_FREQ);
 115              }    
 116          }           
 117            
 118          uint8_t iic0ReadByte(uint8_t ack){//读1个字节，ack=1时，发送ACK，ack=0，发送nACK 
 119                  uint8_t i, receive=0;
 120              for(i=0;i<8;i++ ){
 121                  setSCL0(0); 
 122                  delayUs(CONFIG_I2C0_FREQ);
 123                          setSCL0(1);
 124                  receive <<= 1;
 125                  if(getSDA0())
 126                                  receive ++;   
 127                          delayUs(CONFIG_I2C0_FREQ); 
 128              }                                    
 129              if(!ack)
 130                  iic0NAck();        //发送nACK
 131              else
 132                  iic0Ack();         //发送ACK   
 133              return receive;
 134          }
*** WARNING C316 IN LINE 134 OF Driver\i2c0.c: unterminated conditionals

C51 COMPILATION COMPLETE.  2 WARNING(S),  2 ERROR(S)
